<!DOCTYPE html>
<html>
<head>
    <title>Simple Trello Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Simple Trello Test</h1>
    <button onclick="testTrello()">Test Trello Function</button>
    <div style="margin: 10px 0;">
        <strong>Status:</strong> <span id="status">Loading...</span>
    </div>
    <pre id="output"></pre>

    <script>
        let sb = null;
        let isInitialized = false;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        function initializeSupabase() {
            try {
                if (typeof supabase === 'undefined') {
                    updateStatus('‚ùå Supabase library not loaded');
                    return false;
                }
                
                const { createClient } = supabase;
                sb = createClient(
                    'https://jsxupnogyvfynjgkwdyj.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzeHVwbm9neXZmeW5qZ2t3ZHlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDUxODQsImV4cCI6MjA2NTM4MTE4NH0.GM-u3tU60Dy9dZUYbvXrYB-YMypx7f7TOu1-pAgZ62s'
                );
                
                updateStatus('‚úÖ Ready to test!');
                isInitialized = true;
                return true;
            } catch (error) {
                updateStatus(`‚ùå Init error: ${error.message}`);
                return false;
            }
        }
        
        // Try to initialize immediately
        setTimeout(initializeSupabase, 100);
        
        // Also try when page loads
        window.addEventListener('load', initializeSupabase);
        
        // And try when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeSupabase);

        async function testTrello() {
            const output = document.getElementById('output');
            output.textContent = 'Starting test...\n';

            // Try to initialize if not already done
            if (!isInitialized) {
                output.textContent += 'Attempting to initialize Supabase...\n';
                if (!initializeSupabase()) {
                    output.textContent += 'Failed to initialize Supabase. Please refresh the page.\n';
                    return;
                }
                // Wait a moment for initialization
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            if (!sb) {
                output.textContent += 'ERROR: Supabase client still not available\n';
                return;
            }

            try {
                output.textContent += 'Supabase client ready, testing authentication...\n';
                
                // Generate a unique email for this test
                const timestamp = Date.now();
                const testEmail = `test${timestamp}@example.com`;
                const testPassword = 'password123';
                
                output.textContent += `Creating account with email: ${testEmail}\n`;
                
                // Try to sign up with unique email
                const { data: signUpData, error: signUpError } = await sb.auth.signUp({
                    email: testEmail,
                    password: testPassword
                });
                
                if (signUpError) {
                    output.textContent += `Sign up failed: ${signUpError.message}\n`;
                    
                    // Try to sign in with test@example.com instead
                    output.textContent += 'Trying to sign in with test@example.com...\n';
                    const { data: signInData, error: signInError } = await sb.auth.signInWithPassword({
                        email: 'test@example.com',
                        password: 'password123'
                    });
                    
                    if (signInError) {
                        output.textContent += `Sign in also failed: ${signInError.message}\n`;
                        output.textContent += 'Authentication failed. You may need to sign up manually at http://localhost:8080\n';
                        return;
                    } else {
                        output.textContent += '‚úÖ Signed in successfully!\n';
                    }
                } else {
                    output.textContent += '‚úÖ Account created!\n';
                    
                    // Try to sign in immediately
                    const { data: signInData, error: signInError } = await sb.auth.signInWithPassword({
                        email: testEmail,
                        password: testPassword
                    });
                    
                    if (signInError) {
                        output.textContent += `Sign in failed: ${signInError.message}\n`;
                        output.textContent += 'Account created but sign-in failed. Email confirmation may be required.\n';
                        return;
                    } else {
                        output.textContent += '‚úÖ Signed in successfully!\n';
                    }
                }

                // Now test the Trello function
                output.textContent += '\nüß™ Testing Trello function with your credentials...\n';
                
                const { data, error } = await sb.functions.invoke('save-trello-auth', {
                    body: {
                        apiKey: '8b2a1af38906d0952d769fb593892831',
                        trelloToken: 'ATTA4c33707dd318eb8cce87939838b148d071e88e444b38180641bdb40c9106601403CF00EF'
                    }
                });

                if (error) {
                    output.textContent += `‚ùå FUNCTION ERROR: ${error.message}\n`;
                    if (error.context) {
                        output.textContent += `Context: ${JSON.stringify(error.context, null, 2)}\n`;
                    }
                    output.textContent += '\nüîß This error tells us what needs to be fixed.\n';
                } else {
                    output.textContent += `üéâ SUCCESS! ${JSON.stringify(data, null, 2)}\n`;
                    output.textContent += '\n‚úÖ TRELLO INTEGRATION IS WORKING!\n';
                    output.textContent += '‚úÖ You can now go to http://localhost:8080/settings and connect Trello!\n';
                }

            } catch (err) {
                output.textContent += `üí• EXCEPTION: ${err.message}\n`;
                output.textContent += `Stack: ${err.stack}\n`;
            }
        }
    </script>
</body>
</html> 